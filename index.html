<!DOCTYPE html>
<html lang="">

<head>
  <!-- Google Fonts -->
  <link href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700&display=swap" rel="stylesheet" />
  <!-- MDB -->
  <link href="https://cdnjs.cloudflare.com/ajax/libs/mdb-ui-kit/6.4.0/mdb.min.css" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/ol/dist/ol.js"></script>
  <link rel="icon" type="image/svg" href="https://jole84.se/84.svg" />
  <meta http-equiv='X-UA-Compatible' content='IE=edge'>
  <meta charset="utf-8">
  <meta name='viewport' content='width=device-width, initial-scale=1'>
  <title>jole84.se</title>
  <style>
    #linkButton,
    #linkButton2 {
      width: 50%;
    }

    #kartbild {
      height: 150px;
      overflow: hidden;
      white-space: nowrap;
      font-size: 0;
      background-color: #bfe6ff;
    }

    #objectpreview {
      width: 100%;
      /* height: 350px; */
      border-radius: 5px;
      pointer-events: none;
    }

    #webbkarta,
    #ruttplanering {
      width: 300px;
    }

    #legend {
      height: 150px;
    }

    #brouter-img {
      max-width: 100%;
    }

    #selectFile {
      max-width: 300px;
    }

    #karta {
      max-width: 300px;
    }

    #defaultZoom {
      max-width: 100px;
    }

    #infoText {
      max-width: 200px;
    }

    #gpxUrl {
      max-width: 300px;
    }

    .link {
      text-decoration: underline;
    }

    #linkCode {
      word-break: break-all;
      white-space: pre-wrap;
      line-break: anywhere;
      padding: 15px 0px 15px 0px;
      overflow: hidden;
      display: -webkit-box;
      -webkit-line-clamp: 2;
      -webkit-box-orient: vertical;
    }
  </style>
</head>

<body>
  <header id="kartbild">
    <img src="https://jole84.se/slitlagerkarta/14/8834/4935.jpg">
    <img src="https://jole84.se/slitlagerkarta/14/8835/4935.jpg">
    <img src="https://jole84.se/slitlagerkarta/14/8836/4935.jpg">
  </header>

  <div class="container pt-5">

    <h1>
      Jole84 terräng/vägkarta<br>
    </h1>
    <p class="lead text-muted">Skräddarsydd karta baserad på öppna data från Lantmäteriet (Topografi 50) och vägdata
      från Trafikverket. Enkel webbaserad applikation för navigering utan behov av app-installation samt oberoende av
      operativsystem.</p>
    <a href="https://jole84.se/legend.svg"><img id="legend" class="rounded" src="https://jole84.se/legend.svg"></a><br>
    <hr>

    <a id="linkButton" href="https://jole84.se/nav-app/index.html" class="btn btn-danger my-2">Webbaserad
      navigationsapp</a>
    <a href="https://jole84.se/route-planner/index.html" class="btn btn-warning my-2">jole84 ruttplanerare</a>
    <a href="https://jole84.se/webmap-ol.html" class="btn btn-primary my-2" id="webbkarta">Webbkarta</a>

    <a id="linkButton3" href="https://jole84.se/nav-app/index.html">
      <div>
        <!-- <object id="objectpreview" data="https://jole84.se/nav-app/index.html">Your browser doesn’t support the object tag.</object> -->
        <img id="objectpreview" src="jole84_nav-app_wide.png">
      </div>
    </a>
    <h4>Start-alternativ:</h4>

    <form onchange="myFunction()" id="theForm">
      <label for="gpxUrl"><b>Ladda GPX-fil automatiskt:</b></label>
      <a href="https://jole84.se/rutter" class="link" target="_blank">(Tillängliga rutter)</a><br>
      <select class="form-select" id="selectFile">
        <option>välj gpxfil</option>
      </select><br>
      <input class="form-control" id="gpxUrl" name="gpxUrl" size="20" placeholder=".gpx"><br>
    </form>

    <!-- <button id="createLink" class="btn btn-primary my-2" onclick="myFunction()">Uppdatera länk</button><br> -->
    <input type="file" id="customFileButton" accept=".gpx,application/gpx+xml, .kml" />
    <p><b>Länk för delning:</b><br>
      <code class="user-select-all link" id="linkCode">https://jole84.se/nav-app/index.html</code><br>
    </p>

    <a id="linkButton2" href="https://jole84.se/nav-app/index.html" class="btn btn-danger my-2">Webbaserad
      navigationsapp</a>

    <hr>

    <a href="https://jole84.se/brouter-web/index.html" class="btn btn-primary my-2"
      id="ruttplanering">Ruttplanerare</a><br>
    <a href="https://jole84.se/brouter-web/index.html"><img id="brouter-img" class="rounded"
        src="https://jole84.se/brouter-web.jpg"></a><br>

    <a href="https://jole84.se/html_stuff" class="btn btn-primary my-2" id="ruttplanering">Experiment</a>
    <a href="https://jole84.se/html_stuff/gpx2img.html" class="link" id="gpx2imgLink">GPX2img</a>
    <hr>

    <a href="https://github.com/jole84" class="link">Jole84 Github</a>
  </div>

  <script>
    // const linkUrl = document.getElementById('linkUrl');
    const linkCode = document.getElementById('linkCode');
    const linkButton = document.getElementById('linkButton');
    const gpx2imgLink = document.getElementById('gpx2imgLink');
    const gpxUrl = document.getElementById('gpxUrl');
    const selectFile = document.getElementById('selectFile');
    const customFileButton = document.getElementById("customFileButton");

    var linkUrl = "https://jole84.se/nav-app/index.html"

    function toCoordinateString(coordinate) {
      return [(Number(coordinate[0].toFixed(5))), Number(coordinate[1].toFixed(5))];
    }

    customFileButton.addEventListener("change", (evt) => {
      // linkCode
      const files = evt.target.files;
      const fileExtention = files[0].name.split(".").pop().toLowerCase();
      const poiPoints = [];
      const simplifyTolerance = 0.0001;
      const trackPoints = [];
      let gpxFormat;
      let linkText = "";
      if (fileExtention === "gpx") {
        gpxFormat = new ol.format.GPX();
      } else if (fileExtention === "kml") {
        gpxFormat = new ol.format.KML({ extractStyles: false });
      }


      const reader = new FileReader();
      reader.readAsText(files[0], "UTF-8");
      reader.onload = function (evt) {
        const gpxFeatures = gpxFormat.readFeatures(evt.target.result);
        gpxFeatures.forEach(function (element) {
          if (element.getGeometry().getType() === "Point") {
            poiPoints.push([toCoordinateString(element.getGeometry().getCoordinates()), element.get("name")]);
          }
          else if (element.getGeometry().getType() === "MultiLineString") {
            element.getGeometry().getLineString().simplify(simplifyTolerance).getCoordinates().forEach(function (coordinate) {
              trackPoints.push(toCoordinateString(coordinate));
            });
            poiPoints.push([toCoordinateString(element.getGeometry().getFirstCoordinate()), "Start"]);
            poiPoints.push([toCoordinateString(element.getGeometry().getLastCoordinate()), "Slut"]);
          }
          else if (element.getGeometry().getType() === "LineString") {
            console.log(element.getGeometry().getCoordinates());
            element.getGeometry().simplify(simplifyTolerance).getCoordinates().forEach(function (coordinate) {
              trackPoints.push(toCoordinateString(coordinate));
            });
          }
        });

        if (trackPoints.length > 0) {
          linkText += "trackPoints=" + JSON.stringify(trackPoints);
        }
        if (poiPoints.length > 0) {
          linkText += "&poiPoints=" + JSON.stringify(poiPoints);
        }
        linkCode.innerHTML = "https://jole84.se/nav-app/index.html?" + linkText;
        linkButton.setAttribute("href", "https://jole84.se/nav-app/index.html?" + linkText);
        linkButton2.setAttribute("href", "https://jole84.se/nav-app/index.html?" + linkText);
        document.getElementById('objectpreview').setAttribute("data", "https://jole84.se/nav-app/index.html?" + linkText);
        gpx2imgLink.setAttribute("href", "https://jole84.se/html_stuff/gpx2img.html?" + linkText);
      }
    });

    function myFunction() {
      fetch("https://jole84.se/filesList.json")
        .then((response) => response.json())
        .then((filesList) => {
          for (var i = 0; i < filesList.length; i++) {
            var opt = filesList[i];
            var el = document.createElement("option");
            el.textContent = opt;
            el.value = opt;
            selectFile.appendChild(el);
          }
        }).catch(function (err) {
          console.log('error: ' + err);
        });


      var newLinkUrl = linkUrl + '?';

      if (gpxUrl.value) {
        newLinkUrl += gpxUrl.value;
        gpx2imgLink.setAttribute("href", "https://jole84.se/html_stuff/gpx2img.html?" + gpxUrl.value);
      }

      if (selectFile.value != 'välj gpxfil') {
        newLinkUrl += selectFile.value;
        gpx2imgLink.setAttribute("href", "https://jole84.se/html_stuff/gpx2img.html?" + selectFile.value);
      }

      if (newLinkUrl == linkUrl + '?') {
        linkCode.innerHTML = linkUrl;
        linkButton.setAttribute("href", linkUrl);
        linkButton2.setAttribute("href", linkUrl);
        document.getElementById("linkButton3").setAttribute("href", linkUrl);
      } else {
        linkCode.innerHTML = newLinkUrl;
        linkButton.setAttribute("href", newLinkUrl);
        linkButton2.setAttribute("href", newLinkUrl);
        document.getElementById("linkButton3").setAttribute("href", newLinkUrl);
      }
      document.getElementById('objectpreview').setAttribute("data", newLinkUrl);
    }

    myFunction();
  </script>
</body>

</html>