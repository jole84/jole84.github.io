<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://cdn.jsdelivr.net/npm/ol@9.2.4/dist/ol.js"></script>
    <title>Document</title>
</head>

<body>
    <input id="userNameInput" type="text" placeholder="userName" value="test user">
    <div id="dateSelector">
        <input id="date" type="date">
        <input id="time" type="time">
    </div>
    <input id="headingInput" type="number" min="0" max="360" placeholder="heading">
    <input id="accuracyInput" type="number" placeholder="accuracy">
    <input id="speedInput" type="number" placeholder="speed">
    <p>
        <input id="xInput" type="number" placeholder="x" value=1558472.8711058302 step="100">
        <label for="xInput">x</label>
        <input id="yInput" type="number" placeholder="y" value=7760118.6729024565 step="100">
        <label for="yInput">y</label>
    </p>
    <p>
        <input id="latInput" type="number" placeholder="x" value=57.00 step="0.01">
        <label for="latInput">lat</label>
        <input id="lngInput" type="number" placeholder="y" value=14.00 step="0.01">
        <label for="lngInput    ">lng</label>
    </p>
    <div id="text1"></div>
    <button id="runbutton" onclick="updateUserPosition()">update user</button>
    <button id="removebutton" onclick="removeUserPosition()">remove user</button>
    <pre id="pre1"></pre>
    <script>
        const date = document.getElementById("date");
        const time = document.getElementById("time");
        const userNameInput = document.getElementById("userNameInput");
        const speedInput = document.getElementById("speedInput");
        const accuracyInput = document.getElementById("accuracyInput");
        const headingInput = document.getElementById("headingInput");
        const xInput = document.getElementById("xInput");
        const yInput = document.getElementById("yInput");
        const latInput = document.getElementById("latInput");
        const lngInput = document.getElementById("lngInput");
        const text1 = document.getElementById("text1");
        const pre1 = document.getElementById("pre1");
        const runbutton = document.getElementById("runbutton");
        let setDate = new Date();
        const dateSelector = document.getElementById("dateSelector");
        date.value = (new Date().toLocaleDateString());
        time.value = (new Date().toLocaleTimeString());

        text1.innerHTML = setDate.getTime();

        dateSelector.addEventListener("change", function () {
            setDate = new Date(date.value + "T" + time.value);
            clientPositionArray["timeStamp"] = setDate.getTime();
            text1.innerHTML = setDate.getTime();
        });

        userNameInput.addEventListener("change", function () {
            clientPositionArray["userName"] = userNameInput.value;
        });

        speedInput.addEventListener("change", function () {
            clientPositionArray["speed"] = speedInput.value;
        });

        accuracyInput.addEventListener("change", function () {
            clientPositionArray["accuracy"] = accuracyInput.value;
        });

        headingInput.addEventListener("change", function () {
            clientPositionArray["heading"] = degToRad(headingInput.value);
        });

        xInput.addEventListener("change", function () {
            clientPositionArray["coords"][0] = parseFloat(xInput.value);

            lngInput.value = ol.proj.toLonLat([xInput.value, yInput.value])[0];
            latInput.value = ol.proj.toLonLat([xInput.value, yInput.value])[1];
        });

        yInput.addEventListener("change", function () {
            clientPositionArray["coords"][1] = parseFloat(yInput.value);

            lngInput.value = ol.proj.toLonLat([xInput.value, yInput.value])[0];
            latInput.value = ol.proj.toLonLat([xInput.value, yInput.value])[1];
        });

        latInput.addEventListener("change", function () {
            clientPositionArray["coords"][0] = parseFloat(xInput.value);

            xInput.value = ol.proj.fromLonLat([lngInput.value, latInput.value])[0];
            yInput.value = ol.proj.fromLonLat([lngInput.value, latInput.value])[1];
        });
        console.log(ol.proj.fromLonLat([14, 57]))

        lngInput.addEventListener("change", function () {
            clientPositionArray["coords"][1] = parseFloat(yInput.value);

            xInput.value = ol.proj.fromLonLat([lngInput.value, latInput.value])[0];
            yInput.value = ol.proj.fromLonLat([lngInput.value, latInput.value])[1];
        });

        const clientPositionArray = {
            "coords": [],
        };

        const xhttp = new XMLHttpRequest();
        xhttp.onload = function () {
            try {
                const userList = JSON.parse(this.responseText);
                for (let i = 0; i < userList.length; i++) {
                    userList[i]["localTime"] = new Date(userList[i]["timeStamp"]).toLocaleString();
                    userList[i]["coordinates"] = ol.proj.toLonLat(userList[i]["coords"]);
                    userList[i]["lastUpdate"] = msToTime(Date.now() - userList[i]["timeStamp"]);
                    userList[i]["heading"] = Math.round(radToDeg(userList[i]["heading"]));
                }
                pre1.innerHTML = JSON.stringify(userList, undefined, 2);
            } catch {
                console.log(this.responseText);
            }
        }
        xhttp.open("POST", "https://jole84.se/locationHandler/sql-location-handler.php");
        xhttp.setRequestHeader("Content-Type", "application/x-www-form-urlencoded");
        xhttp.send();

        function removeUserPosition() {
            setDate = new Date(0);
            date.value = (setDate.toLocaleDateString());
            time.value = (setDate.toLocaleTimeString());
            updateUserPosition();
            text1.innerHTML = setDate.getTime();
        }

        function radToDeg(rad) {
            return rad * (180 / Math.PI);
        }

        function degToRad(deg) {
            return (deg * Math.PI * 2) / 360;
        }

        // longitude = 14
        // latitude = 57
        // [14, 57]

        // x = 1 558 472.87110583
        // y = 7 760 118.672902454
        // [1558849.778967426, 7760325.17864454]

        function msToTime(milliseconds) {
            return Math.ceil(milliseconds / 1000 / 60) + " min sedan";
        }

        function updateUserPosition() {
            const xhttp = new XMLHttpRequest();
            clientPositionArray["userName"] = userNameInput.value;
            clientPositionArray["timeStamp"] = setDate.getTime();
            clientPositionArray["coords"] = [parseFloat(xInput.value), parseFloat(yInput.value)];
            clientPositionArray["heading"] = degToRad(headingInput.value) || 0;
            clientPositionArray["accuracy"] = accuracyInput.value || 10;
            clientPositionArray["speed"] = speedInput.value || 0;
            xhttp.onload = function () {
                try {
                    const userList = JSON.parse(this.responseText);
                    for (let i = 0; i < userList.length; i++) {
                        userList[i]["localTime"] = new Date(userList[i]["timeStamp"]).toLocaleString();
                        userList[i]["coordinates"] = ol.proj.toLonLat(userList[i]["coords"]);
                        userList[i]["lastUpdate"] = msToTime(Date.now() - userList[i]["timeStamp"]);
                        userList[i]["heading"] = Math.round(radToDeg(userList[i]["heading"]));
                    }
                    pre1.innerHTML = JSON.stringify(userList, undefined, 2);
                } catch {
                    console.log(this.responseText);
                }
            }
            xhttp.open("POST", "https://jole84.se/locationHandler/sql-location-handler.php");
            xhttp.setRequestHeader("Content-Type", "application/x-www-form-urlencoded");
            xhttp.send("q=" + JSON.stringify(clientPositionArray));
        }
    </script>
</body>

</html>