<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
</head>

<body>
    <input id="userNameInput" type="text" placeholder="userName" value="test user">
    <div id="dateSelector">
        <input id="date" type="date">
        <input id="time" type="time">
    </div>
    <input id="speedInput" type="number" placeholder="speed">
    <input id="headingInput" type="number" min="0" max="6.28" placeholder="heading">
    <p>
        <input id="xInput" type="number" placeholder="x" value=1655000>
        <input id="yInput" type="number" placeholder="y" value=8130000>
    </p>
    <div id="text1"></div>
    <button id="runbutton" onclick="updateUserPosition()">update user</button>
    <button id="removebutton" onclick="removeUserPosition()">remove user</button>
    <pre id="pre1"></pre>
    <script>
        const date = document.getElementById("date");
        const time = document.getElementById("time");
        const userNameInput = document.getElementById("userNameInput");
        const speedInput = document.getElementById("speedInput");
        const headingInput = document.getElementById("headingInput");
        const xInput = document.getElementById("xInput");
        const yInput = document.getElementById("yInput");
        const text1 = document.getElementById("text1");
        const pre1 = document.getElementById("pre1");
        const runbutton = document.getElementById("runbutton");
        let setDate = new Date();
        const dateSelector = document.getElementById("dateSelector");
        date.value = (new Date().toLocaleDateString());
        time.value = (new Date().toLocaleTimeString());

        text1.innerHTML = setDate.getTime();

        dateSelector.addEventListener("change", function () {
            setDate = new Date(date.value + "T" + time.value);
            clientPositionArray["timeStamp"] = setDate.getTime();
            text1.innerHTML = setDate.getTime();
        });

        userNameInput.addEventListener("change", function () {
            clientPositionArray["userName"] = userNameInput.value;
        });

        speedInput.addEventListener("change", function () {
            clientPositionArray["speed"] = speedInput.value;
        });

        headingInput.addEventListener("change", function () {
            clientPositionArray["heading"] = headingInput.value;
        });

        xInput.addEventListener("change", function () {
            clientPositionArray["coords"][0] = parseFloat(xInput.value);
        });

        yInput.addEventListener("change", function () {
            clientPositionArray["coords"][1] = parseFloat(yInput.value);
            console.log(clientPositionArray)
        });

        const clientPositionArray = {
            "coords": [],
        };

        const xhttp = new XMLHttpRequest();
        xhttp.onload = function () {
                try {
                    const userList = JSON.parse(this.responseText);
                    for (let i = 0; i < userList.length; i++) {
                        userList[i]["localTime"] = new Date(userList[i]["timeStamp"]).toLocaleString();
                        userList[i]["coordinates"] = convert3857to4326(userList[i]["coords"]);
                        userList[i]["lastUpdate"] = msToTime(Date.now() - userList[i]["timeStamp"]);
                        userList[i]["heading"] = Math.round(radToDeg(userList[i]["heading"]));
                    }
                    pre1.innerHTML = JSON.stringify(userList, undefined, 2);
                } catch {
                    console.log(this.responseText);
                }
            }
        xhttp.open("POST", "https://jole84.se/locationHandler/sql-location-handler.php");
        xhttp.setRequestHeader("Content-Type", "application/x-www-form-urlencoded");
        xhttp.send();

        function removeUserPosition() {
            setDate = new Date(0);
            date.value = (setDate.toLocaleDateString());
            time.value = (setDate.toLocaleTimeString());
            updateUserPosition();
        }

        function radToDeg(rad) {
            return rad * (180 / Math.PI);
        }

        function convert3857to4326(coord) {
            const e_value = 2.7182818284;
            const X = 20037508.34;

            const lat3857 = coord[1];
            const long3857 = coord[0];

            //converting the longitute from epsg 3857 to 4326
            const long4326 = (long3857 * 180) / X;

            //converting the latitude from epsg 3857 to 4326 split in multiple lines for readability        
            let lat4326 = lat3857 / (X / 180);
            const exponent = (Math.PI / 180) * lat4326;

            lat4326 = Math.atan(Math.pow(e_value, exponent));
            lat4326 = lat4326 / (Math.PI / 360); // Here is the fixed line
            lat4326 = lat4326 - 90;

            return { lat: lat4326.toFixed(5), lng: long4326.toFixed(5) };
        }
        function msToTime(milliseconds) {
            return milliseconds < 120000 ? "alldeles nyss" : (Math.ceil(milliseconds / 1000 / 60) + " min sedan");
        }

        function updateUserPosition() {
            const xhttp = new XMLHttpRequest();
            clientPositionArray["userName"] = userNameInput.value;
            clientPositionArray["timeStamp"] = setDate.getTime();
            clientPositionArray["coords"] = [parseFloat(xInput.value), parseFloat(yInput.value)];
            clientPositionArray["heading"] = headingInput.value || 0;
            clientPositionArray["accuracy"] = 10;
            clientPositionArray["speed"] = speedInput.value || 0;
            xhttp.onload = function () {
                try {
                    const userList = JSON.parse(this.responseText);
                    for (let i = 0; i < userList.length; i++) {
                        userList[i]["localTime"] = new Date(userList[i]["timeStamp"]).toLocaleString();
                        userList[i]["coordinates"] = convert3857to4326(userList[i]["coords"]);
                        userList[i]["lastUpdate"] = msToTime(Date.now() - userList[i]["timeStamp"]);
                        userList[i]["heading"] = Math.round(radToDeg(userList[i]["heading"]));
                    }
                    pre1.innerHTML = JSON.stringify(userList, undefined, 2);
                } catch {
                    console.log(this.responseText);
                }
            }
            xhttp.open("POST", "https://jole84.se/locationHandler/sql-location-handler.php");
            xhttp.setRequestHeader("Content-Type", "application/x-www-form-urlencoded");
            xhttp.send("q=" + JSON.stringify(clientPositionArray));
        }
    </script>
</body>

</html>